<!DOCTYPE html>
<html lang="hu">
<head>
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SufniAPP LITE</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/color-thief/2.3.0/color-thief.umd.js"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

    <style>
        :root {
            --bg-base: #000000;
            /* [MODIFIED] OPTIMIZATION: Darker background, no transparency for better performance */
            --glass: #141414; 
            --glass-border: #333333;
            --text: #ffffff;
            --dynamic-color: #00d2ff;
        }

        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            margin: 0; padding: 0; background: var(--bg-base); color: var(--text);
            font-family: 'Montserrat', sans-serif; height: 100vh; width: 100vw; overflow: hidden;
            display: flex; transition: background 1s ease;
        }

        /* [MODIFIED] OPTIMIZATION: Reduced transition overhead */
        .app-title span, .nav-item.active, .speedo-hud, .recenter-btn, .weather-temp, .hero-meta, .track-title, .bar {
            transition: color 1s ease, background-color 1s ease, border-color 1s ease;
        }

        /* --- AMBILIGHT & BACKGROUND --- */
        #tv-ambi-canvas { display: none; }
        #ambient-glow {
            /* [MODIFIED] OPTIMIZATION: Replacing inset with explicit positioning for older WebViews */
            position: absolute; top: 0; left: 0; right: 0; bottom: 0; z-index: 0;
            background-color: var(--dynamic-color); opacity: 0; 
            transition: background-color 2s ease, opacity 1s ease; pointer-events: none;
            /* [MODIFIED] OPTIMIZATION: Simplified masking for GPU */
            mask-image: radial-gradient(circle, black 30%, transparent 100%);
            -webkit-mask-image: radial-gradient(circle, black 30%, transparent 100%); 
            transform: scale(1.2) translateZ(0); /* Hardware acceleration */
        }
        #radio-bg {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0; z-index: 0;
            background-size: cover; background-position: center;
            /* [MODIFIED] OPTIMIZATION: Reduced blur radius significantly */
            filter: blur(20px) brightness(0.3); opacity: 0; 
            will-change: opacity; transition: opacity 1s ease;
        }

        /* --- SIDEBAR --- */
        .sidebar {
            width: 90px; background: #0a0a0a; /* Removed alpha to save fill-rate */
            border-right: 1px solid var(--glass-border); display: flex; flex-direction: column; 
            align-items: center; padding-top: 25px; z-index: 50;
        }
        .nav-item {
            width: 60px; height: 60px; margin-bottom: 25px; border-radius: 16px; color: rgba(255,255,255,0.4);
            display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer;
        }
        .nav-item.active { 
            background: #222; color: #fff; 
            border: 1px solid var(--dynamic-color); 
            /* [MODIFIED] OPTIMIZATION: Removed box-shadow glow */
            transform: scale(1.02);
        }
        .nav-icon { font-size: 1.8rem; margin-bottom: 2px; }
        .nav-text { font-size: 0.6rem; font-weight: 800; letter-spacing: 1px; }

        /* --- CONTENT --- */
        .content { flex: 1; display: flex; flex-direction: column; position: relative; z-index: 10; contain: layout; }
        .top-bar { 
            height: 70px; display: flex; align-items: center; justify-content: space-between; padding: 0 30px; z-index: 60;
        }
        .app-title { font-size: 1.6rem; font-weight: 900; letter-spacing: 1px; }
        .clock { font-size: 1.2rem; font-weight: 600; font-family: monospace; opacity: 0.8; }

        .dashboard { flex: 1; display: flex; padding: 10px 20px 20px 20px; gap: 20px; overflow: hidden; }

        /* --- MAIN PANEL --- */
        .player-container {
            flex: 2; background: #000; border-radius: 24px;
            border: 1px solid var(--glass-border); position: relative; overflow: hidden;
            display: flex; flex-direction: column; 
            /* [MODIFIED] OPTIMIZATION: Removed expensive box-shadow */
            transform: translateZ(0); /* Force GPU layer */
        }
        
        video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: contain; z-index: 5; background: black; }
        #youtube-frame { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 6; display: none; border: none; background: black; }

        /* --- MAP VIEW --- */
        #map-view { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 20; display: none; }
        #leaflet-map { width: 100%; height: 100%; background: #111; }
        
        .speedo-hud {
            position: absolute; top: 20px; left: 20px; 
            background: rgba(0,0,0,0.9); padding: 10px 20px; border-radius: 15px;
            border-left: 4px solid var(--dynamic-color);
            z-index: 1000; text-align: center; min-width: 100px;
        }
        .speed-val { font-size: 2.2rem; font-weight: 800; color: white; line-height: 1; font-family: monospace; }
        .speed-unit { font-size: 0.7rem; color: #aaa; font-weight: 700; letter-spacing: 1px; }

        .recenter-btn {
            position: absolute; bottom: 30px; right: 30px; width: 55px; height: 55px; border-radius: 50%;
            background: var(--dynamic-color); color: #000; display: flex; justify-content: center; align-items: center;
            font-size: 1.5rem; border: none; cursor: pointer; z-index: 1000; 
        }
        .recenter-btn:active { transform: scale(0.9); }
        .location-bar {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.9); padding: 8px 25px; border-radius: 30px;
            border: 1px solid rgba(255,255,255,0.2); 
            z-index: 1000; font-weight: 600; font-size: 0.9rem; color: #fff;
            white-space: nowrap; max-width: 60%; overflow: hidden; text-overflow: ellipsis;
        }

        /* --- RIGHT PANEL --- */
        .right-panel {
            flex: 1; background: var(--glass);
            border-radius: 24px; border: 1px solid var(--glass-border);
            display: flex; flex-direction: column; overflow: hidden; position: relative; 
            transform: translateZ(0); /* Force GPU */
        }
        .panel-header { height: 60px; border-bottom: 1px solid var(--glass-border); display: flex; align-items: center; justify-content: center; padding: 0 10px; background: #1a1a1a; }
        
        .nav-search-box { padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); position: relative; display: flex; gap: 8px; }
        .nav-input { flex: 1; background: #222; border: 1px solid #444; color: white; padding: 12px; border-radius: 10px; font-size: 1rem; outline: none; }
        .nav-go-btn { background: var(--dynamic-color); border: none; color: #000; font-weight: 800; border-radius: 10px; padding: 0 20px; cursor: pointer; transition: 0.2s; }
        .suggestions-list { position: absolute; top: 65px; left: 15px; right: 15px; background: #222; border: 1px solid #444; border-radius: 10px; max-height: 200px; overflow-y: auto; z-index: 2000; display: none; }
        .suggestion-item { padding: 12px; border-bottom: 1px solid #333; cursor: pointer; font-size: 0.9rem; }
        .suggestion-item:hover { background: var(--dynamic-color); color: black; }
        .leaflet-routing-container { background: transparent !important; color: white !important; box-shadow: none !important; margin: 0 !important; padding: 0 !important; border: none !important; width: 100% !important; font-family: 'Montserrat', sans-serif !important; }
        .leaflet-routing-alt tr:hover { background: rgba(255,255,255,0.1) !important; cursor: pointer; }
        .leaflet-routing-alt-time { color: var(--dynamic-color); font-weight: bold; font-size: 1.2rem; }

        /* --- OTHERS --- */
        #music-view, #news-view { position: absolute; top: 0; left: 0; right: 0; bottom: 0; z-index: 10; display: none; flex-direction: column; align-items: center; justify-content: center; }
        #news-view { padding: 20px; overflow-y: auto; justify-content: flex-start; }
        .collectors-edition { position: relative; width: 300px; height: 200px; display: flex; align-items: center; cursor: pointer; margin-bottom: 20px; transition: transform 0.2s; } 
        .collectors-edition:active { transform: scale(0.98); } 
        .sleeve { position: absolute; left: 0; top: 0; width: 200px; height: 200px; background-color: #222; background-size: cover; background-position: center; border-radius: 4px; z-index: 20; border: 1px solid rgba(255,255,255,0.1); } 
        .play-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; opacity: 0; transition: 0.3s; } 
        .play-icon { font-size: 5rem; color: white; filter: drop-shadow(0 0 10px black); } 
        .collectors-edition.paused .play-overlay { opacity: 1; } 
        .vinyl-disc { position: absolute; left: 100px; top: 5px; width: 190px; height: 190px; border-radius: 50%; background: #111; background-image: repeating-radial-gradient(#111 0, #111 3px, #1c1c1c 4px, #1c1c1c 5px); z-index: 10; display: flex; justify-content: center; align-items: center; animation: spin 6s linear infinite; will-change: transform; } 
        .collectors-edition.paused .vinyl-disc { animation-play-state: paused; } .radio-sticker { width: 70px; height: 70px; border-radius: 50%; background-color: #fff; background-size: contain; background-position: center; background-repeat: no-repeat; border: 2px solid #fff; } .spindle-hole { position: absolute; width: 8px; height: 8px; background: #000; border-radius: 50%; } @keyframes spin { 100% { transform: rotate(360deg); } }
        .info-area { text-align: center; width: 90%; z-index: 20; display: flex; flex-direction: column; gap: 5px; margin-top: 15px; } .track-title { font-size: 1.6rem; font-weight: 800; color: var(--dynamic-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-shadow: 1px 1px 2px black; } .artist-row { display: flex; align-items: center; justify-content: center; gap: 10px; } .track-artist { font-size: 1.1rem; color: rgba(255,255,255,0.9); letter-spacing: 1px; font-weight: 600; text-shadow: 0 1px 2px black; } .mute-btn { background: none; border: 1px solid rgba(255,255,255,0.3); border-radius: 50%; width: 35px; height: 35px; color: #aaa; cursor: pointer; display: flex; justify-content: center; align-items: center; transition: 0.2s; margin-left: 10px; } .mute-btn:hover { background: rgba(255,255,255,0.2); color: white; } .mute-btn.muted { color: #ff416c; border-color: #ff416c; } 
        /* [MODIFIED] OPTIMIZATION: Reduced animations for visualizer */
        .visualizer-container { height: 30px; margin-top: 10px; display: flex; align-items: flex-end; gap: 6px; } .bar { width: 8px; background: var(--dynamic-color); border-radius: 4px; animation: bounce 0.6s infinite ease-in-out alternate; transition: background 1s; } .bar:nth-child(odd) { animation-duration: 0.5s; } .bar:nth-child(2) { height: 60%; animation-delay: 0.1s; } .bar:nth-child(3) { height: 90%; animation-delay: 0.2s; } .bar:nth-child(4) { height: 50%; animation-delay: 0.3s; } @keyframes bounce { 0% { height: 10%; opacity: 0.5; } 100% { height: 100%; opacity: 1; } }
        .tab-btn { flex: 1; background: transparent; border: none; color: #aaa; font-weight: 800; font-size: 0.8rem; letter-spacing: 1px; padding: 15px 0; cursor: pointer; transition: 0.3s; border-bottom: 3px solid transparent; } .tab-btn:hover { color: white; } .tab-btn.active { color: var(--dynamic-color); border-bottom-color: var(--dynamic-color); } .simple-title { font-weight: 800; letter-spacing: 1px; color: #aaa; } .channel-list { flex: 1; overflow-y: auto; padding: 10px; display: block; } .channel-item { display: flex; align-items: center; padding: 15px; margin-bottom: 8px; background: #252525; border-radius: 16px; cursor: pointer; transition: 0.2s; border: 1px solid transparent; } .channel-item:hover { background: #333; } .channel-item.active { background: #333; border-left: 4px solid var(--dynamic-color); } 
        
        .ch-icon { font-size: 1.4rem; width: 40px; height: 40px; display: flex; justify-content: center; align-items: center; position: relative; } 
        .ch-icon-img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 1px solid rgba(255,255,255,0.2); background: #000; }
        
        .status-dot {
            position: absolute; bottom: 0; right: 0;
            width: 12px; height: 12px; border-radius: 50%;
            border: 2px solid #222; z-index: 10;
        }
        .status-dot.checking { background-color: #666; animation: blink 1s infinite; }
        .status-dot.online { background-color: #00ff41; }
        .status-dot.offline { background-color: #ff416c; }
        @keyframes blink { 50% { opacity: 0.5; } }

        .ch-name { font-weight: 600; font-size: 1rem; flex: 1; padding-left: 10px; } 
        .del-btn { color: #ff416c; padding: 10px; opacity: 0.5; } 
        
        #lyrics-view {
            display: none; flex: 1; padding: 20px; overflow-y: auto; text-align: center;
            position: relative; scroll-behavior: smooth;
        }

        #lyrics-text {
            white-space: pre-wrap; font-size: 1.2rem; line-height: 1.8; color: #eee;
            font-weight: 500; text-shadow: 0 1px 2px black; padding-bottom: 50px;
        }

        .no-lyrics { color: #888; font-style: italic; margin-top: 50px; font-size: 1rem; }
        .offset-display { font-size: 0.8rem; color: #aaa; line-height: 40px; font-family: monospace; }
        .news-item { padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer; } 
        .news-item:hover { background: rgba(255,255,255,0.05); } .news-title { font-weight: 600; font-size: 0.9rem; margin-bottom: 5px; line-height: 1.3; } .news-time { font-size: 0.7rem; color: #aaa; } .weather-card { background: #222; border-radius: 16px; padding: 20px; display: flex; align-items: center; gap: 20px; margin-bottom: 10px; border: 1px solid rgba(255,255,255,0.1); cursor: pointer; transition: 0.2s; } .weather-card:active { transform: scale(0.98); background: #333; } .weather-icon { font-size: 3.5rem; filter: drop-shadow(0 0 5px rgba(255,255,255,0.3)); } .weather-info { flex: 1; } .weather-temp { font-size: 3rem; font-weight: 800; color: var(--dynamic-color); line-height: 1; } .weather-desc { font-size: 1.1rem; opacity: 0.9; font-weight: 600; margin-top: 5px; } .weather-sub { font-size: 0.8rem; opacity: 0.6; margin-top: 2px; } .weekly-forecast { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 20px; -webkit-overflow-scrolling: touch; } .daily-card { background: #222; border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 10px; min-width: 80px; display: flex; flex-direction: column; align-items: center; gap: 5px; } .day-name { font-size: 0.7rem; font-weight: 700; opacity: 0.7; text-transform: uppercase; } .day-icon { font-size: 1.5rem; } .day-temp { font-size: 0.9rem; font-weight: 700; } .day-range { font-size: 0.7rem; opacity: 0.5; } .hero-news { flex: 1; background-size: cover; background-position: center; border-radius: 16px; position: relative; overflow: hidden; display: flex; flex-direction: column; justify-content: flex-end; border: 1px solid rgba(255,255,255,0.1); cursor: pointer; min-height: 200px; } .hero-overlay { background: linear-gradient(to top, rgba(0,0,0,0.95), transparent); padding: 25px; } .hero-title { font-size: 1.4rem; font-weight: 800; margin-bottom: 8px; line-height: 1.3; text-shadow: 0 2px 3px black; } .hero-meta { font-size: 0.75rem; color: var(--dynamic-color); font-weight: bold; text-transform: uppercase; letter-spacing: 1px; } 
        
        #reader-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; z-index: 100; background: #000; display: none; flex-direction: column; animation: slideUp 0.3s ease-out; } 
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } } 
        .reader-header { padding: 15px 25px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center; background: #1a1a1a; } 
        .close-reader-btn { background: rgba(255,255,255,0.1); border: none; color: white; width: 40px; height: 40px; border-radius: 50%; font-size: 1.2rem; cursor: pointer; } 
        .reader-content { flex: 1; overflow-y: auto; padding: 30px; font-family: 'Georgia', serif; color: #eee; line-height: 1.8; font-size: 1.1rem; } 
        .reader-title { font-family: 'Montserrat', sans-serif; font-size: 1.8rem; font-weight: 800; margin-bottom: 20px; color: var(--dynamic-color); line-height: 1.2; } 
        .reader-meta { font-size: 0.8rem; color: #aaa; margin-bottom: 30px; border-bottom: 1px solid #333; padding-bottom: 20px; } 
        .reader-body p { margin-bottom: 20px; } .reader-body img { max-width: 100%; border-radius: 10px; margin: 20px 0; } 
        .reader-loading { position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; background: #000; z-index: 50; display: none; text-align: center; padding: 20px; } 
        .spinner { width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.1); border-top-color: var(--dynamic-color); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px;} 
        #modal { display: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 200; justify-content: center; align-items: center; } 
        .modal-card { background: #1a1a1a; width: 400px; padding: 30px; border-radius: 24px; border: 1px solid #333; } 
        input { width: 100%; padding: 15px; margin-bottom: 15px; background: #0f0f0f; border: 1px solid #333; color: white; border-radius: 12px; font-size: 1rem; outline:none;} 
        .btn { width: 100%; padding: 15px; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; margin-top: 10px; font-size: 1rem; }
    </style>
</head>
<body>

<div id="radio-bg" class="ambient-layer"></div>

<canvas id="tv-ambi-canvas" class="ambient-layer"></canvas>
<div id="ambient-glow"></div>

<div class="sidebar">
    <div class="nav-item active" onclick="switchMainMode('TV')">
        <div class="nav-icon">üì∫</div><div class="nav-text">TV</div>
    </div>
    <div class="nav-item" onclick="switchMainMode('RADIO')">
        <div class="nav-icon">üìª</div><div class="nav-text">R√ÅDI√ì</div>
    </div>
    <div class="nav-item" onclick="switchMainMode('NEWS')">
        <div class="nav-icon">üì∞</div><div class="nav-text">H√çREK</div>
    </div>
    <div class="nav-item" onclick="switchMainMode('MAP')">
        <div class="nav-icon">üó∫Ô∏è</div><div class="nav-text">T√âRK√âP</div>
    </div>
    <div style="flex:1"></div>
    <div class="nav-item" onclick="openModal()">
        <div class="nav-icon">‚ûï</div><div class="nav-text">ADD</div>
    </div>
</div>

<div class="content">
    <div class="top-bar">
        <div class="app-title">Sufni<span id="title-suffix" style="color:var(--dynamic-color)">TV</span></div>
        <div class="clock" id="clock">12:00</div>
    </div>

    <div class="dashboard">
        <div class="player-container">
            <video id="video" controls autoplay playsinline crossorigin="anonymous"></video>
            <iframe id="youtube-frame" allow="autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
            
            <div id="music-view">
                <div class="collectors-edition" id="vinyl-container" onclick="togglePlay()">
                    <div class="sleeve" id="album-sleeve"><div class="play-overlay"><div class="play-icon">‚ñ∂</div></div></div>
                    <div class="vinyl-disc spinning"><div class="radio-sticker" id="radio-sticker"></div><div class="spindle-hole"></div></div>
                </div>
                <div class="info-area">
                    <div class="track-title" id="song-title">V√ÅLASSZ AD√ìT</div>
                    <div class="artist-row"><div class="track-artist" id="song-artist">√âL≈ê STREAM</div><button class="mute-btn" id="mute-btn" onclick="toggleMute(event)">üîä</button></div>
                </div>
                <div class="visualizer-container"><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div></div>
            </div>

            <div id="news-view">
                <div class="weather-card" id="weather-card" onclick="forceRefreshWeather()">
                    <div class="weather-icon" id="weather-icon">üå§</div>
                    <div class="weather-info"><div class="weather-temp" id="weather-temp">--¬∞C</div><div class="weather-desc" id="weather-desc">Helyadat...</div><div class="weather-sub">Koppints a friss√≠t√©shez</div></div>
                </div>
                <div class="weekly-forecast" id="weekly-forecast"></div>
                <div class="hero-news" id="hero-news" onclick="openReader(this.dataset.url, this.dataset.title)">
                    <div class="hero-overlay"><div class="hero-title">H√≠rek bet√∂lt√©se...</div><div class="hero-meta">TELEX</div></div>
                </div>
            </div>

            <div id="map-view">
                <div id="leaflet-map"></div>
                <div class="speedo-hud">
                    <div class="speed-val" id="speed-val">0</div>
                    <div class="speed-unit">KM/H</div>
                </div>
                <button class="recenter-btn" onclick="recenterMap()">üéØ</button>
                <div class="location-bar" id="location-bar">Poz√≠ci√≥ keres√©se...</div>
            </div>

            <div id="reader-overlay">
                <div class="reader-header"><span style="font-weight:bold; letter-spacing:1px;">OLVAS√ì M√ìD</span><button class="close-reader-btn" onclick="closeReader()">‚úï</button></div>
                <div class="reader-content">
                    <div id="reader-loading" class="reader-loading"><div class="spinner"></div><div>H√≠r bet√∂lt√©se...</div></div>
                    <div id="reader-error" style="display:none; text-align:center; padding-top:50px;"><h3 style="color:#ff416c">Hopp√°!</h3><button class="btn" onclick="window.open(currentNewsUrl, '_blank')">üåê Megnyit√°s B√∂ng√©sz≈ëben</button></div>
                    <div id="reader-container"><div class="reader-title" id="reader-title"></div><div class="reader-meta" id="reader-meta"></div><div class="reader-body" id="reader-body"></div></div>
                </div>
            </div>
        </div>

        <div class="right-panel">
            <div class="panel-header" id="panel-header"></div>
            
            <div class="channel-list" id="list"></div>
            <div id="lyrics-view"><div id="lyrics-text" class="no-lyrics">V√°lassz r√°di√≥t...</div></div>

            <div id="route-panel" style="display:none; flex-direction:column; height:100%;">
                <div class="nav-search-box">
                    <input id="nav-destination" class="nav-input" placeholder="Hova megy√ºnk? (V√°ros/Utca)" oninput="handleSearchInput(this.value)">
                    <button class="nav-go-btn" onclick="triggerRouteCalculation()">GO</button>
                    <div id="suggestions-list" class="suggestions-list"></div>
                </div>
                <div id="route-instructions" style="flex:1; overflow-y:auto; padding:10px;">
                    <div style="text-align:center; color:#aaa; margin-top:20px;">√çrj be egy c√≠met √©s nyomj a GO gombra!</div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="modal">
    <div class="modal-card">
        <h2 style="color:white; margin-top:0">√öJ AD√ì</h2>
        <input id="inp-name" placeholder="N√©v">
        <input id="inp-url" placeholder="URL">
        <button class="btn" style="background:var(--dynamic-color); color:black" onclick="saveChannel()">MENT√âS</button>
        <button class="btn" style="background:#333; color:white" onclick="closeModal()">M√âGSE</button>
    </div>
</div>

<img id="temp-img" style="display:none;" crossorigin="anonymous">

<script>
    const DATA_VERSION = 8; 

    const STREAM_IDS = { 
        'kossuth': 4501, 'bart√≥k': 4601, 'dank√≥': 4701, 'pet≈ëfi r√°di√≥': 4801, 
        'nemzetis√©gi': 4901, 'retro r√°di√≥': 5001, 'best fm': 5101, 'r√°di√≥ 1': 5201, 
        'rock fm': 5301, 'dikh': 5401, 'm1': 5501, 'm4 sport': 5601, 'euronews': 5701,
        'h√≠r.fm': 5801, 'h√≠rtv': 5901, 'lo-fi girl': 6001, 'cool fm': 6101, 'danubius r√°di√≥': 6201,
        'sunshine r√°di√≥': 6301, 'poptarisznya': 6401, 'r√°di√≥ 7': 6501, 'club dance radio': 6601,
        'music wave': 6701, 'the good life radio': 6801, 'radio 2025': 6901, 'oxygen music': 7001,
        'oxygen': 7101,
    };

    const LOGO_DB={
        'r√°di√≥ 1':'https://myonlineradio.hu/public/uploads/radio_img/radio-1/play_250_250.webp',
        'retro r√°di√≥':'https://myonlineradio.hu/public/uploads/radio_img/retro-radio/play_250_250.webp',
        'pet≈ëfi r√°di√≥':'https://myonlineradio.hu/public/uploads/radio_img/mr2-petofi-radio/play_250_250.webp',
        'best fm': 'https://myonlineradio.hu/public/uploads/radio_img/best-fm/play_250_250.webp',
        'base fm': 'https://myonlineradio.hu/public/uploads/radio_img/base-fm/play_250_250.webp',
        'rock fm': 'https://myonlineradio.hu/public/uploads/radio_img/rock-radio/play_250_250.webp',
        'oxygen music': 'https://play-lh.googleusercontent.com/eKcrVJdid83lhz38jertTRDMVtEC5dkKankClwi_4OXFfXiwvRzcd_wVNkgiL-xldg',
        'oxygen': 'https://play-lh.googleusercontent.com/eKcrVJdid83lhz38jertTRDMVtEC5dkKankClwi_4OXFfXiwvRzcd_wVNkgiL-xldg',
        'lo-fi girl': 'https://yt3.googleusercontent.com/7rkXK4g4Lbpetl0Bz9Wd35Y-p2bPTttMn_K4seCE2JmmXPrqOSd8atpeTbLSyo1sIrlSqB-xbg=s160-c-k-c0x00ffffff-no-rj',
        'm1': 'https://yt3.googleusercontent.com/kNDIyO1IvpSQX5WTi5GD3iXDgcFiziQvcjY9h8NA8GPqUmptEdDBEMgmEOehaHyD8mnOgxKJfbE=s160-c-k-c0x00ffffff-no-rj',
        'euronews': 'https://yt3.googleusercontent.com/z_vAJPT5amuJ8qPo-E4E_ig8A69Q6FQpYHZ0lIjTFy5lYAZCUwYatOc9vpDUWkZlKMF8vcIO8tc=s160-c-k-c0x00ffffff-no-rj',
        'h√≠r.fm': 'https://yt3.googleusercontent.com/ZNRj7Nyq7YeOdD9yhs2soKuQRu7pVYMQX3S03AxJna_knwjepQ8AmqGnYjxWYDA0s0iCYVvf=s160-c-k-c0x00ffffff-no-rj',
        'm4 sport': 'https://yt3.googleusercontent.com/WgA8t9SdnyeG1l80HliUouf3Hoy7n-Ki5ku9Qf8M3kV723Pvf8Ji-nTIFAKEjVPDV4kZUL9H9g=s160-c-k-c0x00ffffff-no-rj', 
        'h√≠rtv': 'https://yt3.googleusercontent.com/orHL8-mWVJgfMgBMOuWCJts0np3nlaMxcu8dqyQfh9AhNO1Ncd__w9cs8k0mvzV780lzVix8=s160-c-k-c0x00ffffff-no-rj',
        'cool fm': 'https://myonlineradio.hu/public/uploads/radio_img/coolfm/play_250_250.webp',
        'danubius r√°di√≥': 'https://myonlineradio.hu/public/uploads/radio_img/danubius-radio/play_250_250.webp',
        'sunshine r√°di√≥': 'https://myonlineradio.hu/public/uploads/radio_img/sunshine-radio/play_250_250.webp',
        'poptarisznya': 'https://myonlineradio.hu/public/uploads/radio_img/poptarisznya/play_250_250.webp',
        'r√°di√≥ 7': 'https://myonlineradio.hu/public/uploads/radio_img/radio-7/play_250_250.webp',
        'club dance radio': 'https://myonlineradio.hu/public/uploads/radio_img/club-dance-radio/play_250_250.webp',
        'music wave': 'https://yt3.googleusercontent.com/tfi3br_JNuMJcwFRboTCnck6T9cuRMh-SjPosUSNMeMHyAviRz3-sSfWJZgjEp5PoNeBnMn-=s160-c-k-c0x00ffffff-no-rj',
        'the good life radio': 'https://yt3.googleusercontent.com/ytc/AIdro_kcXcgjU4A8Pj5xPx-8W_7CI41u7Oq2L7rxqhUnY1Zrme8=s160-c-k-c0x00ffffff-no-rj',
        'radio 2025': 'https://yt3.googleusercontent.com/L4bYkZKh3ooUOkCQHBygIgN_9BkF6FXl-8b4dMMYr_RKYnzr4Uz4xGuc1KHEcdJbIDHUWr_Z=s160-c-k-c0x00ffffff-no-rj',
    };

    const DEFAULTS=[
        {name:"M1 (YT)", url: "https://www.youtube.com/watch?v=_Z03zwFd8yI", type: 'TV'},
        {name:"H√≠rTV", url: "https://video2.videa.hu/static/live/8.2966061.2530409.1.5.590.590/index.m3u8", type: 'TV'},
        {name:"Oxygen Music", url: "https://oxygenmusic.hu:2443/hls/oxygenmusic.m3u8", type: 'TV'},
        {name:"Lo-Fi Girl (YT)", url: "https://www.youtube.com/watch?v=jfKfPfyJRdk", type: 'TV'}, 
        {name:"Euronews (YT)", url: "https://www.youtube.com/watch?v=jAn7L2Kt32U", type: 'TV'},
        {name:"H√≠r.fm (YT)", url: "https://www.youtube.com/watch?v=3glZY3rb1G4", type: 'TV'},
        {name:"Music Wave (YT)", url: "https://www.youtube.com/watch?v=9CX1ov0GzFo", type: 'TV'},
        {name:"The Good Life Radio (YT)", url: "https://www.youtube.com/watch?v=36YnV9STBqc", type: 'TV'},
        {name:"Radio 2025 (YT)", url: "https://www.youtube.com/watch?v=I4FclAh5dsg", type: 'TV'},

        {name:"Cool FM",url:"https://mediagw.viacomkft.hu/stream/coolfm",type:'RADIO'},
        {name:"Oxygen Music", url: "https://oxygenmusic.hu:8443/oxygenmusic_192", type: 'RADIO'},
        {name:"Sunshine R√°di√≥",url:"https://sunshine1.stream.composeit.hu/sunshine",type:'RADIO'},
        {name:"Danubius R√°di√≥",url:"https://stream.danubiusradio.hu/danubius_HiFi",type:'RADIO'},
        {name:"Retro R√°di√≥",url:"https://icast.connectmedia.hu/5001/live.mp3",type:'RADIO'},
        {name:"Best FM",url:"https://icast.connectmedia.hu/5101/live.mp3",type:'RADIO'},
        {name:"R√°di√≥ 1",url:"https://icast.connectmedia.hu/5201/live.mp3",type:'RADIO'},
        {name:"Rock FM",url:"https://icast.connectmedia.hu/5301/live.mp3",type:'RADIO'},
        {name:"Base FM",url:"https://icast.connectmedia.hu/5401/live.mp3",type:'RADIO'},
        {name:"Poptarisznya",url:"https://stream1.virtualisan.net/prx/8200/live.mp3",type:'RADIO'},
        {name:"R√°di√≥ 7", url: "https://a9.asurahosting.com/listen/radio7/radio.mp3", type: 'RADIO'},
        {name:"Club Dance Radio", url: "https://stream.clubdance.online:8002/live.ogg", type: 'RADIO'},
    ];

    let savedVersion = parseInt(localStorage.getItem('v78_version')) || 0;
    let channels = JSON.parse(localStorage.getItem('v78_thumb_channels')) || DEFAULTS;
    
    if (savedVersion < DATA_VERSION) {
        channels = DEFAULTS;
        localStorage.setItem('v78_thumb_channels', JSON.stringify(channels));
        localStorage.setItem('v78_version', DATA_VERSION);
    } else if(!localStorage.getItem('v78_thumb_channels')) {
        localStorage.setItem('v78_thumb_channels', JSON.stringify(DEFAULTS));
        channels = DEFAULTS;
        localStorage.setItem('v78_version', DATA_VERSION);
    }

    let currentMainMode = 'TV'; let rightPanelMode = 'LIST'; let hls = null; let currentStationName = ''; let currentStationUrl = '';
    let currentNewsUrl = ""; let cachedLocation = null; let map = null; let mapMarker = null; let watchId = null; let routingControl = null;
    let searchTimeout = null; let routingTimeout = null;
    let ambiInterval = null;
    const ambiCanvas = document.getElementById('tv-ambi-canvas');
    const ambiCtx = ambiCanvas.getContext('2d');
    const ambiGlow = document.getElementById('ambient-glow');
    const colorThief = new ColorThief();
    
    const video = document.getElementById('video'); 
    const youtubeFrame = document.getElementById('youtube-frame');
    const musicView = document.getElementById('music-view'); const newsView = document.getElementById('news-view'); const mapView = document.getElementById('map-view');
    const routePanel = document.getElementById('route-panel'); const routeInstructions = document.getElementById('route-instructions');
    const suggestionsList = document.getElementById('suggestions-list'); const navInput = document.getElementById('nav-destination');
    const readerOverlay = document.getElementById('reader-overlay'); const readerLoading = document.getElementById('reader-loading'); const readerError = document.getElementById('reader-error'); const readerContainer = document.getElementById('reader-container');
    const weeklyForecast = document.getElementById('weekly-forecast'); const albumSleeve = document.getElementById('album-sleeve'); const radioSticker = document.getElementById('radio-sticker'); const songTitle = document.getElementById('song-title'); const songArtist = document.getElementById('song-artist'); 
    const radioBg = document.getElementById('radio-bg');
    const tempImg = document.getElementById('temp-img'); const titleSuffix = document.getElementById('title-suffix'); const panelHeader = document.getElementById('panel-header'); const listView = document.getElementById('list'); const lyricsView = document.getElementById('lyrics-view'); const lyricsText = document.getElementById('lyrics-text'); const vinylContainer = document.getElementById('vinyl-container'); const muteBtn = document.getElementById('mute-btn'); const heroNews = document.getElementById('hero-news'); const speedVal = document.getElementById('speed-val'); const locationBar = document.getElementById('location-bar');

    setInterval(() => { document.getElementById('clock').innerText = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); }, 1000);

    class StreamHealthMonitor {
        constructor() { this.queue = []; this.processing = false; }
        
        check(url, elementId) {
            this.queue.push({url, elementId});
            if(!this.processing) this.next();
        }

        async next() {
            if(this.queue.length === 0) { this.processing = false; return; }
            this.processing = true;
            const {url, elementId} = this.queue.shift();
            
            if(url.includes('youtube') || url.includes('youtu.be')) {
                this.setStatus(elementId, 'online');
                setTimeout(() => this.next(), 50);
                return;
            }

            try {
                const controller = new AbortController();
                const id = setTimeout(() => controller.abort(), 3000);
                
                try {
                    const response = await fetch(url, { method: 'HEAD', signal: controller.signal });
                    clearTimeout(id);
                    if (response.ok || response.status === 405) this.setStatus(elementId, 'online'); 
                    else this.setStatus(elementId, 'offline');
                    setTimeout(() => this.next(), 100);
                } catch (e) {
                    clearTimeout(id);
                    await this.checkMedia(url, elementId);
                }
            } catch (e) {
                this.setStatus(elementId, 'offline');
                this.next();
            }
        }

        checkMedia(url, elementId) {
            return new Promise(resolve => {
                const tempMedia = document.createElement(url.includes('.m3u8') ? 'video' : 'audio');
                tempMedia.muted = true;
                tempMedia.preload = 'metadata';
                
                const timeout = setTimeout(() => {
                    tempMedia.src = "";
                    this.setStatus(elementId, 'offline');
                    resolve();
                    this.next();
                }, 4000);

                tempMedia.onloadedmetadata = () => {
                    clearTimeout(timeout);
                    this.setStatus(elementId, 'online');
                    tempMedia.src = "";
                    resolve();
                    this.next();
                };

                tempMedia.onerror = () => {
                    clearTimeout(timeout);
                    this.setStatus(elementId, 'offline');
                    resolve();
                    this.next();
                };

                if (url.includes('.m3u8') && Hls.isSupported()) {
                     const hlsCheck = new Hls();
                     hlsCheck.loadSource(url);
                     hlsCheck.on(Hls.Events.MANIFEST_PARSED, () => {
                         clearTimeout(timeout);
                         hlsCheck.destroy();
                         this.setStatus(elementId, 'online');
                         resolve();
                         this.next();
                     });
                     hlsCheck.on(Hls.Events.ERROR, () => {
                     });
                } else {
                    tempMedia.src = url;
                }
            });
        }

        setStatus(id, status) {
            const dot = document.getElementById(id);
            if(dot) {
                dot.className = `status-dot ${status}`;
                dot.title = status === 'online' ? 'Online' : 'Offline / Nem el√©rhet≈ë';
            }
        }
    }
    const streamMonitor = new StreamHealthMonitor();

    class MetadataService {
        constructor() { this.interval = null; this.isPolling = false; this.stationName = ''; this.stationUrl = ''; }
        
        start(stationName, stationUrl) { 
            this.stop(); 
            this.isPolling = true; 
            this.stationName = stationName; 
            this.stationUrl = stationUrl;
            this.fetchData(); 
            this.interval = setInterval(() => this.fetchData(), 10000); 
        }
        
        stop() { this.isPolling = false; if (this.interval) clearInterval(this.interval); }
        
        cleanText(text) { 
            if(!text) return text; 
            let cleaned = text.replace(/^(most\s+sz[√≥o]l(t)?|ad√°sban|jelenleg|m≈±soron)\s*:?\s*/i, "").trim();
            try { cleaned = decodeURIComponent(escape(cleaned)); } catch(e) {}
            cleaned = cleaned.replace(/\+/g, ' & ');
            return cleaned; 
        }
        
        async fetchData() {
            if (!this.isPolling) return;
            const cleanName = this.stationName.toLowerCase();
            let success = false;
            if(this.stationUrl && !this.stationUrl.includes('.m3u8')) { success = await this.fetchFromStreamServer(this.stationUrl); }
            if (!success) { const streamId = this.findStreamId(cleanName); if (streamId) { try { success = await this.fetchConnectMedia(streamId); } catch(e) {} } }
            if (!success) { if (cleanName.includes('sl√°ger')) success = await this.fetchSlager(); else if (cleanName.includes('rocker')) success = await this.fetchRocker(); }
            if (!success) success = await this.fetchMyOnlineRadio(cleanName);
            if (!success && songArtist.innerText === "Adatbet√∂lt√©s...") activateDJMode(this.stationName);
        }

        findStreamId(name) { for (const [key, id] of Object.entries(STREAM_IDS)) { if (name.includes(key)) return id; } return null; }
        
        async fetchWithProxy(targetUrl, type = 'json') {
            const timeStamp = Date.now(); 
            const antiCacheUrl = targetUrl.includes('?') ? `${targetUrl}&nocache=${timeStamp}` : `${targetUrl}?nocache=${timeStamp}`;
            try { const res = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(antiCacheUrl)}`); if(res.ok) { const wrapper = await res.json(); if(wrapper && wrapper.contents) { if (type === 'json') { try { return JSON.parse(wrapper.contents); } catch(e) { return null; } } return wrapper.contents; } } } catch(e) { }
            try { const res = await fetch(`https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(antiCacheUrl)}`); if(res.ok) { if (type === 'json') return await res.json(); return await res.text(); } } catch(e) { }
            try { const res = await fetch(`https://thingproxy.freeboard.io/fetch/${antiCacheUrl}`); if(res.ok) { if (type === 'json') return await res.json(); return await res.text(); } } catch(e) { }
            return null;
        }

        async fetchConnectMedia(streamId) { const url = `https://api.connectmedia.hu/api/v3/streams/${streamId}/shows/now`; const data = await this.fetchWithProxy(url, 'json'); if (data && data.data && data.data.song) { const { artist, title, cover, started_at } = data.data.song; if (!title || title.length < 2) return false; updateTrackInfo(this.cleanText(artist.name || artist), this.cleanText(title), cover, started_at); return true; } return false; }
        async fetchFromStreamServer(streamUrl) { try { let baseUrl = streamUrl.substring(0, streamUrl.lastIndexOf('/') + 1); const statusUrl = `${baseUrl}status-json.xsl`; const data = await this.fetchWithProxy(statusUrl, 'json'); if (data && data.icestats && data.icestats.source) { let source = Array.isArray(data.icestats.source) ? data.icestats.source[0] : data.icestats.source; if(Array.isArray(data.icestats.source)) { const mount = streamUrl.substring(streamUrl.lastIndexOf('/')); const specific = data.icestats.source.find(s => s.listenurl.includes(mount)); if(specific) source = specific; } if (source && (source.title || source.artist)) { let artist, title; if (source.artist && source.title) { artist = source.artist; title = source.title; } else if (source.title) { const parts = source.title.split(' - '); if (parts.length >= 2) { artist = parts[0]; title = parts.slice(1).join(' - '); } else { artist = this.stationName; title = source.title; } } if(title) { updateTrackInfo(this.cleanText(artist), this.cleanText(title), null, null); return true; } } } } catch (e) { } return false; }
        async fetchSlager() { try { const data = await this.fetchWithProxy('https://slager.fm/now_playing.php', 'json'); if (data && data[0]) { updateTrackInfo(data[0].artist, data[0].song, null, null); return true; } } catch (e) { } return false; }
        async fetchRocker() { try { const res = await fetch(`https://rockerradio.online/nowplaying.json?_=${Date.now()}`); const data = await res.json(); if(data.artist && data.song) { updateTrackInfo(data.artist, data.song, data.cover, null); return true; } } catch(e) {} return false; }
        async fetchMyOnlineRadio(stationName) { const slugMap = { 'r√°di√≥ 1': 'radio-1', 'retro': 'retro-radio', 'pet≈ëfi': 'mr2-petofi-radio', 'kossuth': 'kossuth-radio', 'bart√≥k': 'bartok-radio', 'sl√°ger': 'slager-fm', 'best': 'best-fm', 'cool fm': 'coolfm', 'danubius r√°di√≥': 'danubius-radio', 'sunshine r√°di√≥': 'sunshine-radio', 'poptarisznya': 'poptarisznya', 'r√°di√≥ 7': 'radio-7', 'club dance radio': 'club-dance-radio', 'base fm': 'base-fm', 'oxygen music': 'oxygen-music', 'rock fm': 'rock-radio', 'base': 'base-fm', 'dikh': 'dikh-radio', 'oxygen': 'oxygen-music', 'jazz': 'jazz-radio', 'dank√≥': 'danko-radio', 'rock': 'rock-radio', 'nemzetis√©gi': 'nemzetisgi-radio'}; let slug = null; for(const [k, v] of Object.entries(slugMap)) { if(stationName.toLowerCase().includes(k)) { slug = v; break; } } if(!slug) slug = stationName.replace(/\s+/g, '-').toLowerCase(); try { const html = await this.fetchWithProxy(`https://myonlineradio.hu/${slug}`, 'text'); if(!html || html.length < 500) return false; const doc = new DOMParser().parseFromString(html, "text/html"); const element = doc.querySelector('.actSong .progCont'); if (element) { const fullText = element.textContent.trim(); if(fullText.includes('-')) { const splitIndex = fullText.indexOf('-'); let artist = fullText.substring(0, splitIndex).trim(); artist = this.cleanText(artist); let title = fullText.substring(splitIndex + 1).trim(); title = this.cleanText(title); if(artist && title && !title.includes('M≈±sorvezet≈ë') && !title.includes('H√≠rek')) { let cover = null; const img = doc.querySelector('.js-on-air-now-cover, .radiopage-header-image img'); if(img) cover = img.src; updateTrackInfo(artist, title, cover, null); return true; } } } } catch (e) { } return false; }
    }
    const metadataService = new MetadataService();

    function startAmbilight() {
        if(ambiInterval) clearInterval(ambiInterval);
        ambiCanvas.width = 5; ambiCanvas.height = 5;
        // [MODIFIED] OPTIMIZATION: Increased interval from 3s to 5s to reduce CPU load
        ambiInterval = setInterval(() => {
            if(currentMainMode === 'TV' && video.style.display !== 'none' && !video.paused && !video.ended) {
                try {
                    ambiCtx.drawImage(video, 0, 0, 5, 5);
                    const frameData = ambiCtx.getImageData(0, 0, 5, 5).data;
                    let r=0, g=0, b=0, count=0;
                    for(let i=0; i<frameData.length; i+=4) { r += frameData[i]; g += frameData[i+1]; b += frameData[i+2]; count++; }
                    r = Math.floor(r/count); g = Math.floor(g/count); b = Math.floor(b/count);
                    if (r+g+b < 100) { r+=40; g+=40; b+=40; }
                    document.documentElement.style.setProperty('--dynamic-color', `rgb(${r},${g},${b})`);
                } catch(e) { }
            }
        }, 5000); 
    }
    function stopAmbilight() { if(ambiInterval) clearInterval(ambiInterval); }

    function switchMainMode(mode) {
        currentMainMode = mode;
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        let idx = 0; if(mode === 'RADIO') idx = 1; if(mode === 'NEWS') idx = 2; if(mode === 'MAP') idx = 3;
        document.querySelectorAll('.nav-item')[idx].classList.add('active');
        
        if(mode === 'TV') titleSuffix.innerText = 'TV'; else if(mode === 'RADIO') titleSuffix.innerText = 'RADIO'; else if(mode === 'NEWS') titleSuffix.innerText = 'DUMA'; else titleSuffix.innerText = 'NAVI';
        
        video.style.display = 'none'; youtubeFrame.style.display = 'none'; 
        musicView.style.display = 'none'; newsView.style.display = 'none'; mapView.style.display = 'none';
        listView.style.display = 'none'; lyricsView.style.display = 'none'; routePanel.style.display = 'none';
        radioBg.style.opacity = '0'; ambiGlow.style.opacity = '0';

        if (mode === 'TV') {
            panelHeader.innerHTML = '<span class="simple-title">CSATORN√ÅK</span>';
            listView.style.display = 'block'; renderList(); stopMapTracking(); metadataService.stop();
            if(youtubeFrame.src && youtubeFrame.src.includes('youtube')) { radioBg.style.opacity = '1'; ambiGlow.style.opacity = '0.6'; } else { ambiGlow.style.opacity = '0.6'; startAmbilight(); }
        } 
        else if (mode === 'RADIO') {
            musicView.style.display = 'flex'; panelHeader.innerHTML = `<button class="tab-btn active" onclick="switchRightPanel('LIST')">√ÅLLOM√ÅSOK</button><button class="tab-btn" onclick="switchRightPanel('LYRICS')">DALSZ√ñVEG</button>`;
            switchRightPanel('LIST'); renderList(); stopMapTracking();
            if(currentStationName) metadataService.start(currentStationName, currentStationUrl);
            radioBg.style.opacity = '1'; stopAmbilight();
        }
        else if (mode === 'NEWS') {
            newsView.style.display = 'flex'; panelHeader.innerHTML = '<span class="simple-title">FRISS H√çREK</span>';
            listView.style.display = 'block'; metadataService.stop(); stopAmbilight(); resetVisuals(); 
            if (cachedLocation) updateWeatherUI(cachedLocation.lat, cachedLocation.lon, cachedLocation.city); else fetchWeather(true);
            fetchNews(); stopMapTracking();
        }
        else if (mode === 'MAP') {
            mapView.style.display = 'block'; panelHeader.innerHTML = '<span class="simple-title">√öTVONAL</span>';
            routePanel.style.display = 'flex'; metadataService.stop(); stopAmbilight(); resetVisuals(); initMap();
        }
    }

    function initMap() { 
        if(!map) { 
            map = L.map('leaflet-map', { zoomControl: false, attributionControl: false, fadeAnimation: false, zoomAnimation: false }).setView([47.4979, 19.0402], 16); 
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { subdomains: 'abcd', maxZoom: 19 }).addTo(map); 
            mapMarker = L.marker([47.4979, 19.0402], {icon: L.divIcon({ className: 'custom-div-icon', html: "<div style='font-size:30px; color:#00d2ff; text-shadow:0 0 10px #00d2ff; transform: rotate(0deg);'>‚û§</div>", iconSize: [30, 30], iconAnchor: [15, 15] }) }).addTo(map); 
        } 
        setTimeout(() => map.invalidateSize(), 100); startMapTracking(); 
    }
    
    function startMapTracking() { if ("geolocation" in navigator) { watchId = navigator.geolocation.watchPosition(updatePosition, (err) => { locationBar.innerText = "GPS Jel keres√©se..."; }, { enableHighAccuracy: false, maximumAge: 3000, timeout: 10000 }); } }
    function stopMapTracking() { if (watchId) { navigator.geolocation.clearWatch(watchId); watchId = null; } }
    function recenterMap() { if(cachedLocation && map) { map.flyTo([cachedLocation.lat, cachedLocation.lon], 17); } }
    async function updatePosition(pos) { const lat = pos.coords.latitude; const lon = pos.coords.longitude; const speed = pos.coords.speed; if(map && mapMarker) { const newLatLng = new L.LatLng(lat, lon); mapMarker.setLatLng(newLatLng); if(!map.isZooming()) map.panTo(newLatLng); } const kmh = speed ? Math.round(speed * 3.6) : 0; speedVal.innerText = kmh; if(!cachedLocation || (Math.abs(cachedLocation.lat - lat) > 0.005)) { try { const geoRes = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lon}&localityLanguage=hu`); const geoData = await geoRes.json(); const address = `${geoData.city || geoData.locality}, ${geoData.route || ''} ${geoData.streetNumber || ''}`; locationBar.innerText = address.replace(/undefined/g, '').trim() || "Ismeretlen √∫t"; cachedLocation = { lat, lon, city: geoData.locality || geoData.city }; } catch(e) { } } }

    function handleSearchInput(query) { clearTimeout(searchTimeout); if(query.length < 3) { suggestionsList.style.display = 'none'; return; } searchTimeout = setTimeout(async () => { try { const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&countrycodes=hu&limit=5`); const data = await res.json(); suggestionsList.innerHTML = ''; if(data.length > 0) { suggestionsList.style.display = 'block'; data.forEach(item => { const div = document.createElement('div'); div.className = 'suggestion-item'; div.innerText = item.display_name.split(',').slice(0, 3).join(','); div.onclick = () => { navInput.value = div.innerText; suggestionsList.style.display = 'none'; }; suggestionsList.appendChild(div); }); } else { suggestionsList.style.display = 'none'; } } catch(e) {} }, 600); }
    async function triggerRouteCalculation() { const destInput = navInput.value; if(!destInput) return; if(!cachedLocation) { alert("Nincs GPS jel!"); return; } routeInstructions.innerHTML = '<div style="text-align:center; color:#00d2ff; margin-top:20px;">Tervez√©s...</div>'; try { const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(destInput)}`); const data = await res.json(); if(data && data.length > 0) { calculateRouteFinal(parseFloat(data[0].lat), parseFloat(data[0].lon)); } else { routeInstructions.innerHTML = '<div style="text-align:center; color:#ff416c; margin-top:20px;">C√≠m nem tal√°lhat√≥.</div>'; } } catch(e) { routeInstructions.innerHTML = '<div style="text-align:center; color:#ff416c; margin-top:20px;">Hiba a keres√©sben.</div>'; } }
    function calculateRouteFinal(destLat, destLon) { if(routingControl) { map.removeControl(routingControl); routingControl = null; } if(routingTimeout) { clearTimeout(routingTimeout); } routingTimeout = setTimeout(() => { routeInstructions.innerHTML = '<div style="text-align:center; color:#ff416c; margin-top:20px;">Id≈ët√∫ll√©p√©s.</div>'; }, 15000); routingControl = L.Routing.control({ waypoints: [ L.latLng(cachedLocation.lat, cachedLocation.lon), L.latLng(destLat, destLon) ], createMarker: function() { return null; }, lineOptions: { styles: [{color: '#00d2ff', opacity: 0.8, weight: 6}] }, addWaypoints: false, draggableWaypoints: false, fitSelectedRoutes: true, show: false, serviceUrl: 'https://router.project-osrm.org/route/v1', formatter: new L.Routing.Formatter({ language: 'hu' }) }).addTo(map); routingControl.on('routesfound', function(e) { clearTimeout(routingTimeout); const routes = e.routes; const summary = routes[0].summary; const time = Math.round(summary.totalTime / 60) + " perc"; const dist = (summary.totalDistance / 1000).toFixed(1) + " km"; let html = `<div style="padding:10px; border-bottom:1px solid #333; margin-bottom:10px;"> <div style="font-size:1.5rem; color:#00d2ff; font-weight:800;">${time}</div> <div style="font-size:1rem; color:#aaa;">${dist}</div> </div>`; routes[0].instructions.forEach(instr => { let icon = "‚¨ÜÔ∏è"; if(instr.type.includes('Right')) icon = "‚û°Ô∏è"; if(instr.type.includes('Left')) icon = "‚¨ÖÔ∏è"; if(instr.type.includes('Roundabout')) icon = "üîÑ"; if(instr.type === 'DestinationReached') icon = "üèÅ"; html += `<div style="display:flex; gap:10px; padding:8px 0; border-bottom:1px solid rgba(255,255,255,0.05);"> <div style="font-size:1.2rem;">${icon}</div> <div style="flex:1; font-size:0.9rem;">${instr.text}</div> <div style="font-weight:bold; color:#00d2ff;">${Math.round(instr.distance)}m</div> </div>`; }); routeInstructions.innerHTML = html; }); routingControl.on('routingerror', function(e) { clearTimeout(routingTimeout); routeInstructions.innerHTML = '<div style="text-align:center; color:#ff416c; margin-top:20px;">Hiba.</div>'; }); }

    function togglePlay() { if (video.paused) { video.play(); vinylContainer.classList.remove('paused'); } else { video.pause(); vinylContainer.classList.add('paused'); } }
    function toggleMute(e) { if(e) e.stopPropagation(); video.muted = !video.muted; muteBtn.innerText = video.muted ? "üîá" : "üîä"; muteBtn.classList.toggle('muted', video.muted); }
    function getYouTubeId(url) { const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/; const match = url.match(regExp); return (match && match[2].length === 11) ? match[2] : null; }

    function play(ch, el) {
        if(currentMainMode === 'NEWS' || currentMainMode === 'MAP') return;
        document.querySelectorAll('.channel-item').forEach(i => i.classList.remove('active'));
        if(el) el.classList.add('active');
        
        video.pause(); youtubeFrame.src = ""; youtubeFrame.style.display = 'none';

        if(ch.type === 'RADIO') {
            video.style.display = 'none'; musicView.style.display = 'flex'; newsView.style.display = 'none'; mapView.style.display = 'none';
            currentStationName = ch.name; currentStationUrl = ch.url;
            songTitle.innerText = ch.name; songArtist.innerText = "Adatbet√∂lt√©s..."; 
            setVinylLogo(ch.name); albumSleeve.style.backgroundImage = 'none'; vinylContainer.classList.remove('paused');
            lyricsView.innerHTML = '<div id="lyrics-text" style="color:#aaa; padding-top:50px;">üîç Adatok bet√∂lt√©se...</div>';
            metadataService.start(ch.name, ch.url);
            radioBg.style.opacity = '1'; stopAmbilight(); ambiGlow.style.opacity = '0';

            if(hls) { hls.destroy(); hls = null; } 
            if(Hls.isSupported() && ch.url.includes('.m3u8')) { hls = new Hls(); hls.loadSource(ch.url); hls.attachMedia(video); hls.on(Hls.Events.MANIFEST_PARSED, () => video.play()); } else { video.src = ch.url; video.play(); }

        } else {
            musicView.style.display = 'none'; newsView.style.display = 'none'; mapView.style.display = 'none'; metadataService.stop(); resetVisuals();
            const ytId = getYouTubeId(ch.url);
            if(ytId) {
                video.style.display = 'none'; youtubeFrame.style.display = 'block';
                const origin = window.location.origin === 'file://' ? '*' : window.location.origin;
                youtubeFrame.src = `https://www.youtube.com/embed/${ytId}?autoplay=1&mute=0&controls=0&showinfo=0&rel=0&iv_load_policy=3&modestbranding=1&enablejsapi=1&origin=${origin}`;
                stopAmbilight(); applyCover(`https://img.youtube.com/vi/${ytId}/hqdefault.jpg`); radioBg.style.opacity = '1'; ambiGlow.style.opacity = '0.6';
            } else {
                video.style.display = 'block'; radioBg.style.opacity = '0'; ambiGlow.style.opacity = '0.6'; startAmbilight(); 
                if(hls) { hls.destroy(); hls = null; }
                if(Hls.isSupported() && ch.url.includes('.m3u8')) { hls = new Hls(); hls.loadSource(ch.url); hls.attachMedia(video); hls.on(Hls.Events.MANIFEST_PARSED, () => video.play()); } else { video.src = ch.url; video.play(); }
            }
        }
    }
    
    function updateTrackInfo(artist, title, coverUrl = null, startedAt = null) {
        const currentArtist = songArtist.innerText; const currentTitle = songTitle.innerText;
        if(currentArtist === artist && currentTitle === title) return; 
        songArtist.innerText = artist; songTitle.innerText = title;
        if (coverUrl) applyCover(coverUrl); else { const searchQ = `${artist} ${title}`.replace(/feat\.|ft\.|prod\./gi, "").replace(/\(.*\)/g, ""); searchCover(searchQ); }
        fetchLyricsLrcLib(artist, title, startedAt);
        if (currentMainMode === 'RADIO') switchRightPanel('LYRICS');
    }

    async function activateDJMode(stationName) { songArtist.innerText = stationName; songTitle.innerText = "ZENEI V√ÅLOGAT√ÅS"; searchCover("radio station aesthetic"); }
    async function searchCover(query) { try { const res = await fetch(`https://itunes.apple.com/search?term=${encodeURIComponent(query)}&entity=song&limit=1`); const data = await res.json(); if(data.results && data.results.length && data.results[0].artworkUrl100) { applyCover(data.results[0].artworkUrl100.replace('100x100', '600x600')); return; } } catch(e) {} applyCover('https://images.unsplash.com/photo-1470225620780-dba8ba36b745?auto=format&fit=crop&w=600&q=80'); }
    
    async function fetchLyricsLrcLib(artist, title) {
        const container = document.getElementById('lyrics-view');
        if(songArtist.innerText === "Adatbet√∂lt√©s...") { container.innerHTML = '<div id="lyrics-text" style="color:#aaa; padding-top:50px;">üîç Adatok bet√∂lt√©se...</div>'; return; }
        container.innerHTML = '<div id="lyrics-text" style="color:#aaa; padding-top:50px;">üîç Keres√©s...</div>';
        try {
            const url = `https://lrclib.net/api/search?artist_name=${encodeURIComponent(artist)}&track_name=${encodeURIComponent(title)}`;
            const res = await fetch(url); const data = await res.json();
            if (data && data.length > 0) {
                let finalLyrics = data[0].plainLyrics || (data[0].syncedLyrics ? data[0].syncedLyrics.replace(/\[\d{2}:\d{2}(\.\d{2,3})?\]/g, '') : null);
                if (finalLyrics) { container.innerHTML = `<div id="lyrics-text">${finalLyrics.trim()}</div>`; } else { throw new Error("√úres"); }
            } else { container.innerHTML = '<div class="no-lyrics">‚ùå Nincs sz√∂veg.</div>'; }
        } catch(e) { container.innerHTML = '<div class="no-lyrics">‚ö†Ô∏è Nem tal√°lhat√≥.</div>'; }
    }

    function getLogoUrl(name) { const cleanName = name.toLowerCase(); for (const [key, url] of Object.entries(LOGO_DB)) { if (cleanName.includes(key)) { return url; } } return null; }
    function setVinylLogo(name){ const logoUrl = getLogoUrl(name); radioSticker.style.backgroundImage=logoUrl?`url('${logoUrl}')`:'none'; }
    function applyCover(url){ albumSleeve.style.backgroundImage=`url('${url}')`; radioBg.style.backgroundImage=`url('${url}')`; tempImg.src=url; tempImg.onload=()=>{ if(currentMainMode === 'NEWS' || currentMainMode === 'MAP') return; try{ const c=colorThief.getColor(tempImg); const l=(c[0]*299+c[1]*587+c[2]*114)/1000; let r=c[0],g=c[1],b=c[2]; if(l<90){ r=Math.min(255,r+100); g=Math.min(255,g+100); b=Math.min(255,b+100); } document.documentElement.style.setProperty('--dynamic-color',`rgb(${r},${g},${b})`); }catch(e){} }; }
    function resetVisuals(){radioBg.style.backgroundImage=`url('https://images.unsplash.com/photo-1534850336045-c6c6d287f89e?q=80&w=1920&auto=format&fit=crop')`;document.documentElement.style.setProperty('--dynamic-color','#00d2ff');}
    function switchRightPanel(view){rightPanelMode=view;const tabs=document.querySelectorAll('.tab-btn');tabs.forEach(t=>t.classList.remove('active'));if(view==='LIST'){tabs[0]?.classList.add('active');listView.style.display='block';lyricsView.style.display='none';}else{tabs[1]?.classList.add('active');listView.style.display='none';lyricsView.style.display='block';}}
    
    function renderList(){
        listView.innerHTML='';
        const filtered=channels.filter(c=>c.type===(currentMainMode==='RADIO'?'RADIO':'TV'));
        filtered.forEach((ch, index) => {
            const logoUrl = getLogoUrl(ch.name);
            const defaultIcon = currentMainMode==='TV'?'üì∫':'üéµ';
            const iconHtml = logoUrl ? `<img src="${logoUrl}" class="ch-icon-img">` : defaultIcon;
            
            const statusId = `status-${index}-${Date.now()}`;

            const el=document.createElement('div');
            el.className='channel-item';
            el.innerHTML=`
                <div class="ch-icon">
                    ${iconHtml}
                    <div id="${statusId}" class="status-dot checking"></div>
                </div>
                <div class="ch-name">${ch.name}</div>
                <div class="del-btn" onclick="del(event, '${ch.name}')">‚úï</div>`;
            el.onclick=()=>play(ch,el);
            listView.appendChild(el);
            
            streamMonitor.check(ch.url, statusId);
        });
    }

    function openModal(){document.getElementById('modal').style.display='flex';}function closeModal(){document.getElementById('modal').style.display='none';}function saveChannel(){const name=document.getElementById('inp-name').value;const url=document.getElementById('inp-url').value;if(name&&url){channels.push({name,url,type:currentMainMode});localStorage.setItem('v78_thumb_channels',JSON.stringify(channels));closeModal();renderList();}}function del(e,name){e.stopPropagation();channels=channels.filter(c=>c.name!==name);localStorage.setItem('v78_thumb_channels',JSON.stringify(channels));renderList();}
    async function openReader(url,title){if(!url)return;currentNewsUrl=url;readerOverlay.style.display='flex';readerLoading.style.display='flex';readerError.style.display='none';readerContainer.style.display='none';document.getElementById('reader-title').innerText=title;document.getElementById('reader-meta').innerText="Bet√∂lt√©s...";document.getElementById('reader-body').innerHTML="";let success=await tryFetchArticle(url,`https://api.allorigins.win/get?url=${encodeURIComponent(url)}&t=${Date.now()}`,'json');if(!success)success=await tryFetchArticle(url,`https://corsproxy.io/?${encodeURIComponent(url)}`,'html');readerLoading.style.display='none';if(success){readerContainer.style.display='block';document.getElementById('reader-meta').innerText="Forr√°s: Telex.hu";}else{readerError.style.display='block';}}
    async function tryFetchArticle(originalUrl,proxyUrl,type){try{const res=await fetch(proxyUrl);let htmlContent="";if(type==='json'){const data=await res.json();htmlContent=data.contents;}else{htmlContent=await res.text();}if(!htmlContent||htmlContent.length<100)return false;const parser=new DOMParser();const doc=parser.parseFromString(htmlContent,"text/html");let article=doc.querySelector('.article-html-content')||doc.querySelector('article')||doc.querySelector('main');if(article){let content="";const elements=article.querySelectorAll('p, h2, ul, img, figure');elements.forEach(el=>{if(el.closest('.advertisement')||el.closest('.related-articles'))return;if(el.tagName==='P'&&el.innerText.length>10)content+=`<p>${el.innerHTML}</p>`;else if(el.tagName==='H2')content+=`<h3 style="margin-top:20px; color:#00d2ff">${el.innerText}</h3>`;else if(el.tagName==='IMG'||el.tagName==='FIGURE'){let img=el.tagName==='IMG'?el:el.querySelector('img');if(img){let src=img.getAttribute('src')||img.getAttribute('data-src');if(src&&!src.includes('data:image')){if(!src.startsWith('http'))src=new URL(src,originalUrl).href;content+=`<img src="${src}" style="max-width:100%; border-radius:10px; margin:15px 0;">`;}}}else if(el.tagName==='UL')content+=`<ul>${el.innerHTML}</ul>`;});if(content.length<50)return false;document.getElementById('reader-body').innerHTML=content;return true;}return false;}catch(e){return false;}}
    function closeReader(){readerOverlay.style.display='none';}
    async function fetchNews(){listView.innerHTML='<div style="padding:20px; text-align:center; color:#aaa">H√≠rek bet√∂lt√©se...</div>';try{const proxy='https://api.rss2json.com/v1/api.json?rss_url=https://telex.hu/rss';const res=await fetch(proxy);const data=await res.json();if(data.items){const hero=data.items[0];const heroImg=hero.enclosure?.link||hero.thumbnail||'https://telex.hu/assets/images/telex-fb-share.jpg';heroNews.style.backgroundImage=`url('${heroImg}')`;heroNews.querySelector('.hero-title').innerText=hero.title;heroNews.dataset.url=hero.link;heroNews.dataset.title=hero.title;listView.innerHTML='';for(let i=1;i<data.items.length;i++){const item=data.items[i];const div=document.createElement('div');div.className='news-item';div.innerHTML=`<div class="news-title">${item.title}</div><div class="news-time">${new Date(item.pubDate).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</div>`;div.onclick=()=>openReader(item.link,item.title);listView.appendChild(div);}}}catch(e){listView.innerHTML='<div style="padding:20px;">Hiba.</div>';}}
    async function fetchWeather(useGps=false){let lat=47.4984,lon=19.0408;let city="Budapest";if(useGps&&navigator.geolocation){document.getElementById('weather-desc').innerText="Hely...";navigator.geolocation.getCurrentPosition(async(pos)=>{lat=pos.coords.latitude;lon=pos.coords.longitude;try{const geoRes=await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lon}&localityLanguage=hu`);const geoData=await geoRes.json();city=geoData.locality||geoData.city||"Helyi id≈ëj√°r√°s";cachedLocation={lat,lon,city};}catch(e){city="Helyi id≈ëj√°r√°s";}updateWeatherUI(lat,lon,city);},()=>{updateWeatherUI(lat,lon,"Nincs GPS");});}else{updateWeatherUI(lat,lon,city);}}
    function forceRefreshWeather(){fetchWeather(true);}
    async function updateWeatherUI(lat,lon,cityName){try{const res=await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,weather_code&daily=weather_code,temperature_2m_max,temperature_2m_min&timezone=auto`);const data=await res.json();const temp=Math.round(data.current.temperature_2m);const code=data.current.weather_code;document.getElementById('weather-temp').innerText=`${temp}¬∞C`;document.getElementById('weather-desc').innerText=cityName;document.getElementById('weather-icon').innerText=getWeatherIcon(code);document.getElementById('weather-sub').innerText="Friss√≠t√©s";weeklyForecast.innerHTML='';const daily=data.daily;const days=['V','H','K','Sz','Cs','P','Sz'];for(let i=0;i<daily.time.length;i++){const date=new Date(daily.time[i]);const dayName=i===0?'MA':days[date.getDay()];const icon=getWeatherIcon(daily.weather_code[i]);const max=Math.round(daily.temperature_2m_max[i]);const min=Math.round(daily.temperature_2m_min[i]);const div=document.createElement('div');div.className='daily-card';div.innerHTML=`<div class="day-name">${dayName}</div><div class="day-icon">${icon}</div><div class="day-temp">${max}¬∞</div><div class="day-range">${min}¬∞</div>`;weeklyForecast.appendChild(div);}}catch(e){}}
    function getWeatherIcon(code){if(code>=95)return"‚õà";if(code>=61)return"üåß";if(code>=51)return"üå¶";if(code>=45)return"üå´";if(code>=3)return"‚òÅÔ∏è";if(code>=1)return"‚õÖ";return"‚òÄÔ∏è";}

    switchMainMode('TV');
</script>
</body>
//#region Diagnostic Overlay
<div id="sufni-diag" style="position:fixed; top:5px; right:5px; background:rgba(0,0,0,0.8); color:#00ff41; font-family:monospace; font-size:10px; padding:5px; border:1px solid #00ff41; z-index:9999; pointer-events:none;">
    FPS: <span id="fps-meter">--</span> | MEM: <span id="mem-meter">--</span>
</div>
<script>
    (function(){
        const fpsElem = document.getElementById('fps-meter');
        const memElem = document.getElementById('mem-meter');
        let frameCount = 0;
        let lastTime = performance.now();

        function updateDiag() {
            const now = performance.now();
            frameCount++;
            if (now - lastTime >= 1000) {
                const fps = Math.round((frameCount * 1000) / (now - lastTime));
                fpsElem.innerText = fps;
                fpsElem.style.color = fps < 20 ? '#ff416c' : (fps < 40 ? '#ffff00' : '#00ff41');
                
                if (performance.memory) {
                    const used = Math.round(performance.memory.usedJSHeapSize / 1024 / 1024);
                    const limit = Math.round(performance.memory.jsHeapSizeLimit / 1024 / 1024);
                    memElem.innerText = `${used} / ${limit} MB`;
                } else {
                    memElem.innerText = "N/A";
                }
                
                frameCount = 0;
                lastTime = now;
            }
            requestAnimationFrame(updateDiag);
        }
        requestAnimationFrame(updateDiag);
    })();
</script>
//#endregion
</html>